--source include/not_embedded.inc

if (!$REUSE_PASSWORD_CHECK_SO) {
  skip No REUSE_PASSWORD_CHECK plugin;
}

install soname "reuse_password_check";

set @save_reuse_password_check_interval= @@reuse_password_check_interval;

set global reuse_password_check_interval= 0;

--echo # Default value (sould be unlimited i.e. 0)
SHOW GLOBAL VARIABLES like "reuse_password_check%";

--echo # insert user
grant select on *.* to user_name@localhost identified by 'test_pwd';

#--error ER_NOT_VALID_PASSWORD
#grant select on *.* to user_name@localhost identified by 'test_pwd';
#show warnings;

--error ER_CANNOT_USER
alter user user_name@localhost identified by 'test_pwd';
show warnings;

# Plugin does not work for it
#--error ER_NOT_VALID_PASSWORD
#SET PASSWORD FOR user_name@localhost = PASSWORD('test_pwd');

--echo # check exparation

set global reuse_password_check_interval= 10;

--error ER_CANNOT_USER
alter user user_name@localhost identified by 'test_pwd';
show warnings;
select hex(hash) from mysql.reuse_password_check_history;

--echo # emulate old password
update mysql.reuse_password_check_history set time= date_sub(now(), interval
11 day);

alter user user_name@localhost identified by 'test_pwd';
show warnings;

drop user user_name@localhost;

show create table mysql.reuse_password_check_history;
select count(*) from mysql.reuse_password_check_history;

drop table mysql.reuse_password_check_history;

set @save_reuse_password_check_interval= @@reuse_password_check_interval;

set global reuse_password_check_interval= @save_reuse_password_check_interval;

uninstall plugin reuse_password_check;
